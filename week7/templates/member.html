<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>歡迎光臨，這是會員頁</title>
</head>
<body>
  <h1 id="welcome-title">{{ member.name }}，歡迎登入系統</h1>


  <p>
    <a href="/logout">登出</a>
  </p>

  <hr />

  <h2>快來留言吧</h2>
  <form action="/createMessage" method="post">
    <input type="text" name="content" placeholder="內容" />
    <button type="submit">送出</button>
  </form>

  <hr />

  <h2>留言</h2>

  {% if messages %}
    <ul>
      {% for msg in messages %}
        <li>
          <strong>{{ msg.author_name }}：</strong>
          {{ msg.content }}

          {% if msg.member_id == member.id %}
            <form action="/deleteMessage" method="post" style="display:inline;" onsubmit="return confirmDelete();">
              <input type="hidden" name="message_id" value="{{ msg.id }}" />
              <button type="submit">刪除</button>
            </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>目前沒有任何留言，快來當第一個留言的人吧！</p>
  {% endif %}

  <hr />

  <!--  week7 Task 2 -->
  <h2>查詢會員資料</h2>

  <label for="query-member-id">
    會員編號：
    <input
      id="query-member-id"
      type="number"
      min="1"
      placeholder="請輸入會員編號（正整數）"
    />
  </label>

  <button id="query-member-btn" type="button">查詢</button>
 
  <p id="query-member-result" style="font-weight:bold; margin-top:8px;"></p>



  <hr />


  <h2>更新姓名</h2>

  <input
    id="update-name-input"
    type="text"
    placeholder="請輸入新的姓名"
  />
  <button id="update-name-btn" type="button">更新</button>

  <p id="update-name-result" style="font-weight:bold; margin-top:8px;"></p>



  <hr />

  <!--  week7 task 4  -->
  <h2>誰查過我</h2>

  <button id="load-query-log-btn" type="button">載入查詢紀錄</button>

  <ul id="query-log-list" style="margin-top:8px;"></ul>
  <p id="query-log-message" style="font-weight:bold; margin-top:8px;"></p>



  <script>

    function confirmDelete() {
      return confirm("確定要刪除這則留言嗎？");
    }



    const queryInput = document.getElementById("query-member-id");      
    const queryButton = document.getElementById("query-member-btn");    
    const queryResult = document.getElementById("query-member-result"); 


    queryButton.addEventListener("click", async function () {

      const idText = queryInput.value.trim();


      if (idText === "") {
        queryResult.textContent = "請輸入會員編號";
        return;  
      }


      const idNumber = Number(idText);  


      if (!Number.isInteger(idNumber) || idNumber <= 0) {
        queryResult.textContent = "會員編號必須是正整數（例如：1、2、3）";
        return;
      }


      queryResult.textContent = "查詢中...";

      try {

        const response = await fetch(`/api/member/${idNumber}`);


        if (!response.ok) {
          queryResult.textContent = "伺服器發生錯誤，請稍後再試";
          return;
        }


        const result = await response.json();

        if (result.data === null) {

          queryResult.textContent = "No Data";
        } else {

          const member = result.data;
          queryResult.innerHTML = `姓名：${member.name}<br>信箱：${member.email}`;
        }
      } catch (error) {
        console.error("查詢發生錯誤：", error);
        queryResult.textContent = "連線失敗，請確認伺服器是否有啟動";
      }
    });
    
    
    // week7 task 3

    const updateInput = document.getElementById("update-name-input");   
    const updateButton = document.getElementById("update-name-btn");   
    const updateResult = document.getElementById("update-name-result"); 
    const welcomeTitle = document.getElementById("welcome-title");      

    
    updateButton.addEventListener("click", async function () {
    
      const newName = updateInput.value.trim();

      if (newName === "") {
        updateResult.textContent = "請輸入新的姓名";
        return;
      }

      updateResult.textContent = "更新中...";

      try {
  
        const response = await fetch("/api/member", {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json", 
          },
          body: JSON.stringify({ name: newName }), 
        });


        if (!response.ok) {
          updateResult.textContent = "Failed to Update";
          return;
        }


        const result = await response.json();

        if (result.ok === true) {

          updateResult.textContent = "Updated";


          if (welcomeTitle) {
            welcomeTitle.textContent = newName + "，歡迎登入系統";
          }
        } else {

          updateResult.textContent = "Failed to Update";
        }
      } catch (error) {
        console.error("更新姓名時發生錯誤：", error);
        updateResult.textContent = "Failed to Update";
      }
    });

    // week7 task 4
    const logButton  = document.getElementById("load-query-log-btn");
    const logList    = document.getElementById("query-log-list");
    const logMessage = document.getElementById("query-log-message");


    logButton.addEventListener("click", async function () {

      logList.innerHTML = "";
      logMessage.textContent = "載入中...";

      try {

        const response = await fetch("/api/member/query-log");

        if (!response.ok) {
          logMessage.textContent = "載入失敗（伺服器錯誤）";
          return;
        }

        const result = await response.json();


        if (!result.data || result.data.length === 0) {

          logMessage.textContent = "目前沒有任何查詢紀錄";
          return;
        }


        logMessage.textContent = "";


        result.data.forEach(record => {
          const li = document.createElement("li");
          li.textContent = `${record.searcher_name} 在 ${record.query_time} 查詢了你的資料`;
          logList.appendChild(li);
        });
      } catch (error) {
        console.error("載入查詢紀錄時發生錯誤：", error);
        logMessage.textContent = "載入失敗（連線錯誤）";
      }
    });
  </script>
</body>
</html>
